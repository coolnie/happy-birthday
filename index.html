<body>

<div class="container">
    <div id="game-area">
        <div class="decor">ğŸ¥‚âœ¨ğŸ‚</div>
        
        <div style="width: 100%; height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; margin: 20px 0; position: relative;">
            <div id="progress" style="width: 0%; height: 100%; background: #fff; border-radius: 5px; transition: 0.5s ease; position: relative;">
                <span id="gift-icon" style="position: absolute; right: -10px; top: -10px; font-size: 20px; transition: 0.5s ease; display: none;">ğŸ</span>
            </div>
        </div>

        <div id="content">
            <h2 id="title">æ­å–œæ˜±å®é•·å¤§ä¸€æ­²ï¼</h2>
            <p id="desc">è«‹é–‹å§‹æ›´æ–°æ‚¨çš„å€‹äººè³‡è¨Š</p>
            <button class="btn-next" onclick="startQuiz()">é–‹å§‹å¡«å¯«</button>
        </div>
    </div>
</div>

<script>
    const FORMSPREE_URL = "https://formspree.io/f/mnjqeopy"; 

    const questions = [
        { type: "yn", q: "1. ä¸å–œæ­¡æµ·é®®ï¼ŒåŒ…æ‹¬é¾è¦è·Ÿç”Ÿé­šç‰‡å£½å¸ï¼Œå¯æ˜¯å–œæ­¡è¦å­ã€è›¤èœŠã€å³éƒ­é­šã€çƒ¤é­·é­š" },
        { type: "yn", q: "2. å–œæ­¡å°éš»çš„è¦å­å‹éå¤§éš»çš„" },
        { type: "yn", q: "3. ä¸å–œæ­¡åœ°ç“œè‘‰" },
        { type: "yn", q: "4. ä¸å–œæ­¡å¾ˆå¤šèŠ‹æ³¥çš„èŠ‹é ­ç‰›å¥¶" },
        { type: "yn", q: "5. è¦ºå¾—æ¾éœ²å¾ˆè‡­" },
        { type: "yn", q: "6. ä¸å–œæ­¡ Mister Donuts" },
        { type: "yn", q: "7. å–œæ­¡é³³æ¢¨&å“ˆå¯†ç“œï¼Œä½†æ˜¯ä¸å–œæ­¡é³³æ¢¨/å“ˆå¯†ç“œå£å‘³çš„æ±è¥¿" },
        { type: "only-yes", q: "8. æˆ‘é•·å¤§äº†ï¼Œæ²’æœ‰ç”šéº¼é›£å¾—å€’æˆ‘ï¼" },
        { type: "input", q: "æœ€å¾Œ. ç”Ÿæ—¥é¡˜æœ›(å¥³æœ‹å‹ä½¿å‘½å¿…é”)" }
    ];

    let currentIdx = 0;
    let birthdayWish = "";
    let corrections = {}; 

    function startQuiz() { showQuestion(); }

    function showQuestion() {
        // ä¿®æ­£é€²åº¦è¨ˆç®—ï¼šè®“ç¬¬ä¸€é¡Œå°±é¡¯ç¤ºé€²åº¦
        const progress = ((currentIdx + 1) / questions.length) * 100;
        const progressEl = document.getElementById('progress');
        const giftEl = document.getElementById('gift-icon');
        
        if (progressEl) progressEl.style.width = progress + '%';
        if (giftEl) giftEl.style.display = 'block';

        const q = questions[currentIdx];
        let html = `<h3>é¡Œç›® ${currentIdx + 1} / ${questions.length}</h3><p>${q.q}</p>`;

        if (q.type === "yn") {
            html += `<div class="btn-group">
                        <button class="btn-yes" onclick="handleYes()">æ˜¯</button>
                        <button class="btn-no" onclick="handleNo()">å¦</button>
                    </div>`;
        } else if (q.type === "input") {
            html += `<textarea id="wish-input" rows="3" placeholder="å¯«ä¸‹ä½ çš„é¡˜æœ›..."></textarea>
                    <button class="btn-next" style="margin-top:10px" onclick="saveWishAndNext()">æäº¤ä¸¦å®Œæˆæ›´æ–°</button>`;
        } else if (q.type === "only-yes") {
            html += `<div class="btn-group">
                        <button class="btn-yes" style="width:100%" onclick="handleYes()">æ˜¯ (ç•¶ç„¶æ˜¯!)</button>
                    </div>`;
        }
        document.getElementById('content').innerHTML = html;
    }

    function handleYes() { 
        createHearts(); 
        setTimeout(nextQuestion, 600); 
    }

    function handleNo() {
        const questionKey = `ç¬¬${currentIdx + 1}é¡Œå›è¦†`;
        document.getElementById('content').innerHTML = `
            <p style="color: #ffeb3b; font-weight: bold;">å”‰å”·å–‚ï¼Œé‡‘æ‹è¬! <br>è«‹æ›´æ–°æ­£ç¢ºè³‡è¨Šï¼Œè®“æˆ‘æä¾›æ‚¨æ›´å¥½çš„äººç”Ÿé«”é©—</p>
            <input type="text" id="correction-input" placeholder="è¼¸å…¥æ­£ç¢ºè³‡è¨Š">
            <button class="btn-next" style="margin-top:15px" onclick="saveCorrectionAndNext('${questionKey}')">æ›´æ–°å®Œæˆ!!</button>
        `;
    }

    function saveCorrectionAndNext(key) {
        const inputEl = document.getElementById('correction-input');
        corrections[key] = inputEl.value || "ï¼ˆé»é¸å¦ä½†æœªè¼¸å…¥æ–‡å­—ï¼‰";
        inputEl.blur(); 
        setTimeout(nextQuestion, 100);
    }

    function saveWishAndNext() {
        birthdayWish = document.getElementById('wish-input').value;
        submitAndFinish(); // æœ€å¾Œä¸€é¡Œå®Œç›´æ¥é€å‡º
    }

    function nextQuestion() {
        currentIdx++;
        if (currentIdx < questions.length) { 
            showQuestion(); 
        }
    }

    function submitAndFinish() {
        createHearts();
        document.getElementById('content').innerHTML = `<p>æ­£åœ¨åŒæ­¥è³‡è¨Šåˆ°å¶çš„å¿ƒä¸­...</p>`;
        
        const payload = {
            "ç”Ÿæ—¥é¡˜æœ›": birthdayWish,
            "ä¿®æ­£è³‡è¨Š": corrections,
            "é•·å¤§å®£è¨€": "æ˜¯"
        };
        
        fetch(FORMSPREE_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' }
        }).finally(() => {
            showFinal();
        });
    }

    function showFinal() {
        document.getElementById('content').innerHTML = `
            <h2>æ„Ÿè¬ä½ çš„é…åˆï¼</h2>
            <p>å·²æ¥æ”¶åˆ°æœ€æ–°è³‡è¨Š >3<</p>
            <button class="btn-next" onclick="showScratch()">æŸ¥çœ‹çå‹µ</button>
        `;
    }

    function showScratch() {
        // æ›¿æ›æ•´å€‹éŠæˆ²å€å¡Šï¼Œé¿å…ç‰ˆé¢æ··äº‚
        document.getElementById('game-area').innerHTML = `
            <div id="scratch-area">
                <h1 style="font-size: 1.5rem;">âœ¨ ç”Ÿæ—¥å…Œæ›åˆ¸ âœ¨</h1>
                
                <div class="scratch-card">
                    <div class="coupon-text">ğŸ‚ å…è²»å¤§é¤ä¸€é “</div>
                    <canvas id="s1" width="260" height="130"></canvas>
                </div>

                <div class="scratch-card">
                    <div class="coupon-text">ğŸ« æ±°èˆŠæ›æ–°åˆ¸</div>
                    <canvas id="s2" width="260" height="130"></canvas>
                </div>

                <p style="font-size: 0.8rem; opacity: 0.8; margin-top: 20px;">ğŸ’¡ æˆªåœ–ä¿å­˜ï¼Œä»¥å…è¨€æ°´é¦¨å¿˜è¨˜</p>
                <p>Happy Birthday â¤ï¸</p>
            </div>
        `;
        initScratch('s1');
        initScratch('s2');
    }

    function createHearts() {
        for(let i=0; i<10; i++) {
            const heart = document.createElement('div');
            heart.className = 'heart';
            heart.innerText = 'â¤';
            heart.style.left = Math.random() * 100 + 'vw';
            heart.style.top = '80vh';
            heart.style.fontSize = (Math.random() * 20 + 20) + 'px';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 1500);
        }
    }

    function initScratch(id) {
        const canvas = document.getElementById(id);
        const ctx = canvas.getContext('2d');
        
        // ç¹ªè£½éŠ€è‰²è¦†è“‹å±¤
        ctx.fillStyle = '#C0C0C0';
        ctx.fillRect(0, 0, 260, 130);
        
        // åŠ ä¸€é»ã€Œåˆ®é–‹æˆ‘ã€çš„æ–‡å­—æç¤º
        ctx.fillStyle = "#888";
        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        ctx.fillText("åˆ®é–‹çœ‹çå‹µ", 130, 75);

        let isDrawing = false;
        const scratch = (e) => {
            if(!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI*2);
            ctx.fill();
        };

        canvas.addEventListener('mousedown', () => isDrawing = true);
        canvas.addEventListener('touchstart', (e) => { isDrawing = true; e.preventDefault(); });
        window.addEventListener('mouseup', () => isDrawing = false);
        window.addEventListener('touchend', () => isDrawing = false);
        canvas.addEventListener('mousemove', scratch);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); scratch(e); });
    }
</script>
</body>
